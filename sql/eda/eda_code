-- =====================================================================
-- EXPLORATORY DATA ANALYSIS (EDA) - DATA WAREHOUSE GOLD LAYER
-- 25 Comprehensive SQL Queries for Business Intelligence
-- =====================================================================

-- SECTION 1: DATA OVERVIEW & STRUCTURE ---------------------------------------------------
-- Q1: Get row counts for all key tables
SELECT 'dim_customers' AS Table_Name, COUNT(*) AS Row_Count FROM Gold.dim_customers
UNION ALL SELECT 'dim_products', COUNT(*) FROM Gold.dim_products  
UNION ALL SELECT 'fact_sales', COUNT(*) FROM Gold.fact_sales;

-- Q2: Data type check for fact_sales columns
SELECT COLUMN_NAME, DATA_TYPE FROM INFORMATION_SCHEMA.COLUMNS 
WHERE TABLE_NAME = 'fact_sales' ORDER BY ORDINAL_POSITION;

-- Q3: Sample of recent sales
SELECT TOP 10 * FROM Gold.fact_sales 
WHERE order_date >= DATEADD(day, -30, GETDATE()) ORDER BY order_date DESC;


-- SECTION 2: DATA QUALITY & COMPLETENESS -------------------------------------------------
-- Q4: Check for NULLs in critical foreign keys
SELECT COUNT(CASE WHEN customer_id IS NULL THEN 1 END) AS null_customer_id,
       COUNT(CASE WHEN product_key IS NULL THEN 1 END) AS null_product_key
FROM Gold.fact_sales;

-- Q5: Validate customer dimension data
SELECT COUNT(CASE WHEN customer_name IS NULL OR customer_name = '' THEN 1 END) AS missing_names,
       COUNT(CASE WHEN gender = 'N/a' THEN 1 END) AS unknown_gender,
       COUNT(CASE WHEN birthdate IS NULL THEN 1 END) AS missing_birthdate
FROM Gold.dim_customers;

-- Q6: Check for invalid dates (ship before order)
SELECT COUNT(*) AS invalid_shipments FROM Gold.fact_sales WHERE ship_date < order_date;

-- Q7: Check for negative or zero values
SELECT COUNT(CASE WHEN quantity <= 0 THEN 1 END) AS invalid_quantity,
       COUNT(CASE WHEN unit_price <= 0 THEN 1 END) AS invalid_price,
       COUNT(CASE WHEN sales_amount <= 0 THEN 1 END) AS invalid_sales
FROM Gold.fact_sales;


-- SECTION 3: CUSTOMER ANALYSIS -----------------------------------------------------------
-- Q8: Customer count by country
SELECT country, COUNT(*) AS customer_count,
       ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS percentage
FROM Gold.dim_customers GROUP BY country ORDER BY customer_count DESC;

-- Q9: Customer demographic breakdown
SELECT gender, age_group, COUNT(*) AS customer_count
FROM Gold.dim_customers WHERE gender != 'N/a'
GROUP BY gender, age_group ORDER BY gender, 
    CASE age_group WHEN '0-17' THEN 1 WHEN '18-25' THEN 2 WHEN '26-35' THEN 3 
    WHEN '36-50' THEN 4 WHEN '51-65' THEN 5 WHEN '65+' THEN 6 ELSE 7 END;

-- Q10: Top 10 customers by total spend
SELECT TOP 10 c.customer_name, c.country, COUNT(DISTINCT f.order_number) AS order_count,
       SUM(f.sales_amount) AS total_spent, AVG(f.profit_margin_percent) AS avg_margin
FROM Gold.fact_sales f JOIN Gold.dim_customers c ON f.customer_id = c.customer_id
GROUP BY c.customer_name, c.country ORDER BY total_spent DESC;

-- Q11: Customer acquisition over time
SELECT YEAR(create_date) AS year, MONTH(create_date) AS month, COUNT(*) AS new_customers
FROM Gold.dim_customers WHERE create_date IS NOT NULL
GROUP BY YEAR(create_date), MONTH(create_date) ORDER BY year, month;


-- SECTION 4: PRODUCT ANALYSIS ------------------------------------------------------------
-- Q12: Product count by category and line
SELECT category_name, product_line, COUNT(*) AS product_count
FROM Gold.dim_products GROUP BY category_name, product_line ORDER BY category_name, product_count DESC;

-- Q13: Product price distribution
SELECT market_segment, COUNT(*) AS product_count, MIN(product_cost) AS min_cost,
       MAX(product_cost) AS max_cost, AVG(product_cost) AS avg_cost
FROM Gold.dim_products GROUP BY market_segment ORDER BY avg_cost DESC;

-- Q14: Top 10 best-selling products by revenue
SELECT TOP 10 p.product_name, p.product_line, COUNT(DISTINCT f.order_number) AS times_ordered,
       SUM(f.quantity) AS total_units_sold, SUM(f.sales_amount) AS total_revenue,
       SUM(f.profit_amount) AS total_profit
FROM Gold.fact_sales f JOIN Gold.dim_products p ON f.product_key = p.product_key
GROUP BY p.product_name, p.product_line ORDER BY total_revenue DESC;

-- Q15: Top 10 most profitable products by margin
SELECT TOP 10 p.product_name, p.product_line, AVG(f.profit_margin_percent) AS avg_margin_percent,
       SUM(f.profit_amount) AS total_profit
FROM Gold.fact_sales f JOIN Gold.dim_products p ON f.product_key = p.product_key
GROUP BY p.product_name, p.product_line HAVING COUNT(*) > 10 ORDER BY avg_margin_percent DESC;


-- SECTION 5: SALES & PERFORMANCE METRICS -------------------------------------------------
-- Q16: Overall sales KPI dashboard
SELECT COUNT(DISTINCT order_number) AS total_orders, COUNT(DISTINCT customer_id) AS unique_customers,
       SUM(quantity) AS total_units_sold, SUM(sales_amount) AS total_revenue,
       SUM(profit_amount) AS total_profit, AVG(profit_margin_percent) AS avg_margin_percent
FROM Gold.fact_sales;

-- Q17: Monthly revenue trend (last 12 months)
SELECT YEAR(order_date) AS year, MONTH(order_date) AS month,
       COUNT(DISTINCT order_number) AS order_count, SUM(sales_amount) AS monthly_revenue,
       SUM(profit_amount) AS monthly_profit
FROM Gold.fact_sales WHERE order_date >= DATEADD(month, -12, GETDATE())
GROUP BY YEAR(order_date), MONTH(order_date) ORDER BY year DESC, month DESC;

-- Q18: Sales by day of week
SELECT DATENAME(weekday, order_date) AS day_of_week, COUNT(*) AS order_count,
       SUM(sales_amount) AS total_revenue, AVG(sales_amount) AS avg_order_value
FROM Gold.fact_sales GROUP BY DATENAME(weekday, order_date), DATEPART(weekday, order_date)
ORDER BY DATEPART(weekday, order_date);

-- Q19: Order size analysis
SELECT order_size_category, COUNT(*) AS order_count, AVG(quantity) AS avg_units_per_order,
       AVG(sales_amount) AS avg_order_value, SUM(sales_amount) AS total_revenue
FROM Gold.fact_sales GROUP BY order_size_category ORDER BY 
    CASE order_size_category WHEN 'Single Unit' THEN 1 WHEN 'Small (2-5 units)' THEN 2
    WHEN 'Medium (6-10 units)' THEN 3 WHEN 'Bulk (>10 units)' THEN 4 ELSE 5 END;

-- Q20: Shipping performance
SELECT shipping_speed_category, COUNT(*) AS order_count, AVG(shipping_days) AS avg_shipping_days,
       MIN(shipping_days) AS min_shipping_days, MAX(shipping_days) AS max_shipping_days,
       SUM(sales_amount) AS total_revenue
FROM Gold.fact_sales GROUP BY shipping_speed_category ORDER BY avg_shipping_days;


-- SECTION 6: ADVANCED BUSINESS INSIGHTS --------------------------------------------------
-- Q21: Product category performance by customer demographics
SELECT p.category_name, c.age_group, c.gender, COUNT(*) AS transaction_count,
       SUM(f.sales_amount) AS total_revenue, AVG(f.profit_margin_percent) AS avg_margin
FROM Gold.fact_sales f JOIN Gold.dim_products p ON f.product_key = p.product_key
JOIN Gold.dim_customers c ON f.customer_id = c.customer_id
WHERE c.gender != 'N/a' GROUP BY p.category_name, c.age_group, c.gender
ORDER BY p.category_name, total_revenue DESC;

-- Q22: Customer segmentation by purchase behavior
WITH customer_stats AS (
    SELECT customer_id, COUNT(DISTINCT order_number) AS order_count,
           SUM(sales_amount) AS total_spent,
           DATEDIFF(day, MIN(order_date), MAX(order_date)) AS customer_span_days
    FROM Gold.fact_sales GROUP BY customer_id
)
SELECT CASE WHEN order_count = 1 THEN 'One-time Buyer'
            WHEN order_count BETWEEN 2 AND 5 THEN 'Repeat Buyer'
            WHEN order_count > 5 THEN 'Frequent Buyer' END AS customer_segment,
       CASE WHEN total_spent < 1000 THEN 'Low Value'
            WHEN total_spent BETWEEN 1000 AND 5000 THEN 'Medium Value'
            WHEN total_spent > 5000 THEN 'High Value' END AS value_segment,
       COUNT(*) AS customer_count, AVG(total_spent) AS avg_spent, AVG(order_count) AS avg_orders
FROM customer_stats GROUP BY CASE WHEN order_count = 1 THEN 'One-time Buyer'
            WHEN order_count BETWEEN 2 AND 5 THEN 'Repeat Buyer'
            WHEN order_count > 5 THEN 'Frequent Buyer' END,
       CASE WHEN total_spent < 1000 THEN 'Low Value'
            WHEN total_spent BETWEEN 1000 AND 5000 THEN 'Medium Value'
            WHEN total_spent > 5000 THEN 'High Value' END ORDER BY customer_count DESC;

-- Q23: Price tier analysis
SELECT price_tier_category, COUNT(*) AS order_count, AVG(quantity) AS avg_units_per_order,
       AVG(unit_price) AS avg_unit_price, AVG(profit_margin_percent) AS avg_margin_percent,
       SUM(sales_amount) AS total_revenue
FROM Gold.fact_sales GROUP BY price_tier_category ORDER BY 
    CASE price_tier_category WHEN 'Budget (<$100)' THEN 1 WHEN 'Standard ($100-$300)' THEN 2
    WHEN 'Premium ($301-$600)' THEN 3 WHEN 'Luxury (>$600)' THEN 4 ELSE 5 END;

-- Q24: Seasonal analysis by month
SELECT MONTH(order_date) AS month_num, DATENAME(month, order_date) AS month_name,
       COUNT(*) AS order_count, SUM(sales_amount) AS total_revenue,
       SUM(profit_amount) AS total_profit
FROM Gold.fact_sales GROUP BY MONTH(order_date), DATENAME(month, order_date) ORDER BY month_num;

-- Q25: Top customer-product combinations
SELECT TOP 10 c.customer_name, p.product_name, COUNT(*) AS purchase_count,
       SUM(f.quantity) AS total_units, SUM(f.sales_amount) AS total_spent
FROM Gold.fact_sales f JOIN Gold.dim_customers c ON f.customer_id = c.customer_id
JOIN Gold.dim_products p ON f.product_key = p.product_key
GROUP BY c.customer_name, p.product_name ORDER BY purchase_count DESC;

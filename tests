-- ===========================================================================
-- DATA QUALITY TESTING SCRIPT FOR BRONZE TO SILVER DATA PIPELINE
-- Purpose: Test data quality issues in Bronze layer, apply fixes, 
--          and verify fixes in Silver layer
-- GitHub: This script should be version controlled in GitHub repository
-- ===========================================================================

/*
EXECUTION INSTRUCTIONS:
1. Run Bronze layer tests to identify data quality issues
2. Apply fixes in the ETL/ELT process
3. Run Silver layer tests to verify issues are resolved
4. Document any remaining issues for future fixes
*/

PRINT '================================================================================';
PRINT 'STARTING DATA QUALITY TESTS';
PRINT 'Test Time: ' + CONVERT(VARCHAR, GETDATE(), 120);
PRINT '================================================================================';

-- ===========================================================================
-- 1. CRM CUSTOMER INFORMATION TESTS
-- ===========================================================================

PRINT CHAR(13) + '1. TESTING CRM CUSTOMER INFORMATION DATA QUALITY';
PRINT '----------------------------------------------------------------';

-- Test 1.1: Check for duplicate customer IDs in Bronze layer
-- Issue: Duplicate cst_id values indicate data duplication
PRINT 'Test 1.1: Checking for duplicate customer IDs in Bronze layer...';
SELECT 
    COUNT(*) AS duplicate_count,
    cst_id
FROM Bronze.crm_cust_info
WHERE cst_id IS NOT NULL
GROUP BY cst_id
HAVING COUNT(*) > 1;

-- Test 1.2: Verify duplicates are removed in Silver layer
-- Expected: Silver should have unique cst_id values
PRINT 'Test 1.2: Verifying duplicates removed in Silver layer...';
SELECT 
    COUNT(*) AS duplicate_count,
    cst_id
FROM Silver.crm_cust_info
GROUP BY cst_id
HAVING COUNT(*) > 1;

-- Test 1.3: Check for whitespace in names in Bronze layer
-- Issue: Leading/trailing whitespace causes data inconsistency
PRINT 'Test 1.3: Checking for whitespace in names in Bronze layer...';
SELECT 
    cst_id,
    cst_firstname,
    cst_lastname
FROM Bronze.crm_cust_info
WHERE cst_firstname != TRIM(cst_firstname) 
   OR cst_lastname != TRIM(cst_lastname);

-- Test 1.4: Verify whitespace is trimmed in Silver layer
-- Expected: Silver should have trimmed names
PRINT 'Test 1.4: Verifying whitespace trimmed in Silver layer...';
SELECT 
    cst_id,
    cst_firstname,
    cst_lastname
FROM Silver.crm_cust_info
WHERE cst_firstname != TRIM(cst_firstname) 
   OR cst_lastname != TRIM(cst_lastname);

-- Test 1.5: Check for invalid gender codes in Bronze layer
-- Issue: Non-standard gender codes need standardization
PRINT 'Test 1.5: Checking for invalid gender codes in Bronze layer...';
SELECT DISTINCT 
    cst_gndr,
    COUNT(*) AS record_count
FROM Bronze.crm_cust_info
GROUP BY cst_gndr
ORDER BY cst_gndr;

-- Test 1.6: Verify gender standardization in Silver layer
-- Expected: Silver should have standardized gender values (Male/Female/N/a)
PRINT 'Test 1.6: Verifying gender standardization in Silver layer...';
SELECT DISTINCT 
    cst_gndr,
    COUNT(*) AS record_count
FROM Silver.crm_cust_info
GROUP BY cst_gndr
ORDER BY cst_gndr;

-- Test 1.7: Check for invalid marital status codes in Bronze layer
-- Issue: Non-standard marital status codes
PRINT 'Test 1.7: Checking for invalid marital status codes in Bronze layer...';
SELECT DISTINCT 
    cst_marital_status,
    COUNT(*) AS record_count
FROM Bronze.crm_cust_info
GROUP BY cst_marital_status
ORDER BY cst_marital_status;

-- Test 1.8: Verify marital status standardization in Silver layer
-- Expected: Silver should have standardized values (Single/Married/N/a)
PRINT 'Test 1.8: Verifying marital status standardization in Silver layer...';
SELECT DISTINCT 
    cst_marital_status,
    COUNT(*) AS record_count
FROM Silver.crm_cust_info
GROUP BY cst_marital_status
ORDER BY cst_marital_status;

-- ===========================================================================
-- 2. CRM PRODUCT INFORMATION TESTS
-- ===========================================================================

PRINT CHAR(13) + '2. TESTING CRM PRODUCT INFORMATION DATA QUALITY';
PRINT '----------------------------------------------------------------';

-- Test 2.1: Check for duplicate product IDs in Bronze layer
-- Issue: Duplicate prd_id values indicate data duplication
PRINT 'Test 2.1: Checking for duplicate product IDs in Bronze layer...';
SELECT 
    prd_id,
    COUNT(*) AS duplicate_count
FROM Bronze.crm_prd_info
GROUP BY prd_id
HAVING COUNT(*) > 1;

-- Test 2.2: Verify duplicates are removed in Silver layer
-- Expected: Silver should have unique product records
PRINT 'Test 2.2: Verifying product data quality in Silver layer...';
SELECT 
    COUNT(*) AS total_records,
    COUNT(DISTINCT prd_id) AS unique_products,
    CASE 
        WHEN COUNT(*) = COUNT(DISTINCT prd_id) 
        THEN 'PASS: No duplicates' 
        ELSE 'FAIL: Duplicates found' 
    END AS duplicate_check
FROM Silver.crm_prd_info;

-- Test 2.3: Check for whitespace in product names in Bronze layer
-- Issue: Inconsistent naming due to whitespace
PRINT 'Test 2.3: Checking for whitespace in product names in Bronze layer...';
SELECT 
    prd_id,
    prd_nm,
    LEN(prd_nm) AS name_length,
    LEN(TRIM(prd_nm)) AS trimmed_length
FROM Bronze.crm_prd_info
WHERE prd_nm != TRIM(prd_nm);

-- Test 2.4: Verify product names are cleaned in Silver layer
-- Expected: Silver should have trimmed product names
PRINT 'Test 2.4: Verifying product names cleaned in Silver layer...';
SELECT 
    prd_id,
    prd_nm
FROM Silver.crm_prd_info
WHERE prd_nm != TRIM(prd_nm);

-- Test 2.5: Check for invalid or negative product costs in Bronze layer
-- Issue: Product cost should be positive
PRINT 'Test 2.5: Checking for invalid product costs in Bronze layer...';
SELECT 
    prd_id,
    prd_nm,
    prd_cost
FROM Bronze.crm_prd_info
WHERE prd_cost <= 0 OR prd_cost IS NULL;

-- Test 2.6: Verify product cost validation in Silver layer
-- Expected: Negative/NULL costs should be defaulted to 0
PRINT 'Test 2.6: Verifying product cost validation in Silver layer...';
SELECT 
    prd_id,
    prd_nm,
    prd_cost
FROM Silver.crm_prd_info
WHERE prd_cost < 0;

-- Test 2.7: Check product line codes in Bronze layer
-- Issue: Non-standard product line codes
PRINT 'Test 2.7: Checking product line codes in Bronze layer...';
SELECT DISTINCT 
    prd_line,
    COUNT(*) AS record_count
FROM Bronze.crm_prd_info
GROUP BY prd_line
ORDER BY prd_line;

-- Test 2.8: Verify product line standardization in Silver layer
-- Expected: Standardized product line categories
PRINT 'Test 2.8: Verifying product line standardization in Silver layer...';
SELECT DISTINCT 
    prd_line,
    COUNT(*) AS record_count
FROM Silver.crm_prd_info
GROUP BY prd_line
ORDER BY prd_line;

-- Test 2.9: Check for date inconsistencies in Bronze layer
-- Issue: Start date should be before end date
PRINT 'Test 2.9: Checking for date inconsistencies in Bronze layer...';
SELECT 
    prd_id,
    prd_nm,
    prd_start_dt,
    prd_end_dt
FROM Bronze.crm_prd_info
WHERE prd_start_dt > prd_end_dt;

-- ===========================================================================
-- 3. CRM SALES DETAILS TESTS
-- ===========================================================================

PRINT CHAR(13) + '3. TESTING CRM SALES DETAILS DATA QUALITY';
PRINT '----------------------------------------------------------------';

-- Test 3.1: Check for multiple line items per order in Bronze layer
-- Expected: Multiple records per order are valid (multiple products in cart)
PRINT 'Test 3.1: Checking order line item counts in Bronze layer...';
SELECT 
    sls_ord_num,
    COUNT(*) AS line_item_count
FROM Bronze.crm_sales_details
GROUP BY sls_ord_num
HAVING COUNT(*) > 1
ORDER BY COUNT(*) DESC;

-- Test 3.2: Verify order structure preserved in Silver layer
PRINT 'Test 3.2: Verifying order structure in Silver layer...';
SELECT 
    sls_ord_num,
    COUNT(*) AS line_item_count
FROM Silver.crm_sales_details
GROUP BY sls_ord_num
HAVING COUNT(*) > 1
ORDER BY COUNT(*) DESC;

-- Test 3.3: Check for invalid/negative prices in Bronze layer
-- Issue: Price should be positive
PRINT 'Test 3.3: Checking for invalid prices in Bronze layer...';
SELECT 
    sls_ord_num,
    sls_prd_key,
    sls_price,
    COUNT(*) AS affected_records
FROM Bronze.crm_sales_details
WHERE sls_price < 0 OR sls_price IS NULL
GROUP BY sls_ord_num, sls_prd_key, sls_price;

-- Test 3.4: Verify price validation in Silver layer
-- Expected: Invalid prices should be recalculated
PRINT 'Test 3.4: Verifying price validation in Silver layer...';
SELECT 
    COUNT(*) AS negative_price_count
FROM Silver.crm_sales_details
WHERE sls_price < 0;

-- Test 3.5: Check for invalid/negative sales amounts in Bronze layer
PRINT 'Test 3.5: Checking for invalid sales amounts in Bronze layer...';
SELECT 
    sls_ord_num,
    sls_prd_key,
    sls_sales,
    COUNT(*) AS affected_records
FROM Bronze.crm_sales_details
WHERE sls_sales < 0 OR sls_sales IS NULL
GROUP BY sls_ord_num, sls_prd_key, sls_sales;

-- Test 3.6: Verify sales amount validation in Silver layer
PRINT 'Test 3.6: Verifying sales amount validation in Silver layer...';
SELECT 
    COUNT(*) AS negative_sales_count
FROM Silver.crm_sales_details
WHERE sls_sales < 0;

-- Test 3.7: Check for invalid quantities in Bronze layer
PRINT 'Test 3.7: Checking for invalid quantities in Bronze layer...';
SELECT 
    sls_ord_num,
    sls_prd_key,
    sls_quantity,
    COUNT(*) AS affected_records
FROM Bronze.crm_sales_details
WHERE sls_quantity <= 0 OR sls_quantity IS NULL
GROUP BY sls_ord_num, sls_prd_key, sls_quantity;

-- Test 3.8: Check for whitespace in order numbers in Bronze layer
PRINT 'Test 3.8: Checking for whitespace in order numbers in Bronze layer...';
SELECT 
    sls_ord_num,
    LEN(sls_ord_num) AS original_length,
    LEN(TRIM(sls_ord_num)) AS trimmed_length
FROM Bronze.crm_sales_details
WHERE sls_ord_num != TRIM(sls_ord_num);

-- Test 3.9: Check for invalid date formats in Bronze layer
-- Expected: Dates should be in YYYYMMDD format
PRINT 'Test 3.9: Checking for invalid date formats in Bronze layer...';
SELECT 
    sls_ord_num,
    sls_order_dt,
    LEN(sls_order_dt) AS date_length
FROM Bronze.crm_sales_details
WHERE LEN(sls_order_dt) != 8 
   OR sls_order_dt IS NULL
   OR TRY_CAST(sls_order_dt AS DATE) IS NULL;

-- Test 3.10: Verify date standardization in Silver layer
PRINT 'Test 3.10: Verifying date standardization in Silver layer...';
SELECT 
    COUNT(*) AS invalid_date_count
FROM Silver.crm_sales_details
WHERE sls_order_dt IS NULL 
   OR sls_ship_dt IS NULL 
   OR sls_due_dt IS NULL;

-- Test 3.11: Check date logic consistency in Silver layer
-- Expected: Order date <= Ship date <= Due date
PRINT 'Test 3.11: Checking date logic consistency in Silver layer...';
SELECT 
    sls_ord_num,
    sls_order_dt,
    sls_ship_dt,
    sls_due_dt,
    DATEDIFF(DAY, sls_order_dt, sls_ship_dt) AS order_to_ship_days,
    DATEDIFF(DAY, sls_ship_dt, sls_due_dt) AS ship_to_due_days
FROM Silver.crm_sales_details
WHERE sls_ship_dt < sls_order_dt 
   OR sls_due_dt < sls_ship_dt;

-- Test 3.12: Verify sales calculation consistency
-- Expected: sales = price * quantity
PRINT 'Test 3.12: Verifying sales calculation consistency...';
SELECT 
    COUNT(*) AS inconsistent_calculations,
    SUM(CASE WHEN ABS(sls_sales - (sls_price * sls_quantity)) > 0.01 THEN 1 ELSE 0 END) AS calculation_errors
FROM Silver.crm_sales_details
WHERE sls_price IS NOT NULL 
   AND sls_quantity IS NOT NULL 
   AND sls_sales IS NOT NULL;

-- ===========================================================================
-- 4. ERP CATEGORY TABLE TESTS
-- ===========================================================================

PRINT CHAR(13) + '4. TESTING ERP CATEGORY DATA QUALITY';
PRINT '----------------------------------------------------------------';

-- Test 4.1: Check for whitespace in maintenance field in Bronze layer
PRINT 'Test 4.1: Checking for whitespace in maintenance field in Bronze layer...';
SELECT 
    ID,
    cat,
    subcat,
    MAINTENANCE,
    LEN(MAINTENANCE) AS original_length,
    LEN(TRIM(MAINTENANCE)) AS trimmed_length
FROM Bronze.erp_category
WHERE MAINTENANCE != TRIM(MAINTENANCE);

-- Test 4.2: Verify maintenance field cleaning in Silver layer
PRINT 'Test 4.2: Verifying maintenance field cleaning in Silver layer...';
SELECT 
    ID,
    MAINTENANCE
FROM Silver.erp_category
WHERE MAINTENANCE != TRIM(MAINTENANCE);

-- Test 4.3: Check distinct maintenance values
PRINT 'Test 4.3: Checking distinct maintenance values in both layers...';
PRINT 'Bronze layer distinct values:';
SELECT DISTINCT MAINTENANCE 
FROM Bronze.erp_category
ORDER BY MAINTENANCE;

PRINT 'Silver layer distinct values:';
SELECT DISTINCT MAINTENANCE 
FROM Silver.erp_category
ORDER BY MAINTENANCE;

-- ===========================================================================
-- 5. ERP CUSTOMER TABLE TESTS
-- ===========================================================================

PRINT CHAR(13) + '5. TESTING ERP CUSTOMER DATA QUALITY';
PRINT '----------------------------------------------------------------';

-- Test 5.1: Check for invalid birth dates in Bronze layer
-- Issue: Birth dates should be realistic (not in future, not too old)
PRINT 'Test 5.1: Checking for invalid birth dates in Bronze layer...';
SELECT 
    CID,
    BDATE,
    DATEDIFF(YEAR, BDATE, GETDATE()) AS estimated_age
FROM Bronze.erp_cust
WHERE BDATE < '1900-01-01' 
   OR BDATE > GETDATE()
   OR BDATE IS NULL;

-- Test 5.2: Verify birth date validation in Silver layer
-- Expected: Invalid dates should be set to NULL
PRINT 'Test 5.2: Verifying birth date validation in Silver layer...';
SELECT 
    COUNT(*) AS invalid_date_count
FROM Silver.erp_cust
WHERE BDATE < '1900-01-01' 
   OR BDATE > GETDATE();

-- Test 5.3: Check gender codes in Bronze layer
PRINT 'Test 5.3: Checking gender codes in Bronze layer...';
SELECT DISTINCT 
    GEN,
    COUNT(*) AS record_count
FROM Bronze.erp_cust
GROUP BY GEN
ORDER BY GEN;

-- Test 5.4: Verify gender standardization in Silver layer
-- Expected: Standardized to Male/Female/N/a
PRINT 'Test 5.4: Verifying gender standardization in Silver layer...';
SELECT DISTINCT 
    gen,
    COUNT(*) AS record_count
FROM Silver.erp_cust
GROUP BY gen
ORDER BY gen;

-- ===========================================================================
-- 6. ERP LOCATION TABLE TESTS
-- ===========================================================================

PRINT CHAR(13) + '6. TESTING ERP LOCATION DATA QUALITY';
PRINT '----------------------------------------------------------------';

-- Test 6.1: Check country codes in Bronze layer
PRINT 'Test 6.1: Checking country codes in Bronze layer...';
SELECT DISTINCT 
    cntry,
    COUNT(*) AS record_count
FROM Bronze.erp_loc
GROUP BY cntry
ORDER BY cntry;

-- Test 6.2: Verify country standardization in Silver layer
-- Expected: Standardized country names
PRINT 'Test 6.2: Verifying country standardization in Silver layer...';
SELECT DISTINCT 
    CNTRY,
    COUNT(*) AS record_count
FROM Silver.erp_loc
GROUP BY CNTRY
ORDER BY CNTRY;

-- Test 6.3: Check for hyphen removal in customer IDs
PRINT 'Test 6.3: Checking customer ID cleaning in both layers...';
PRINT 'Bronze layer sample with hyphens:';
SELECT TOP 5 
    cid,
    REPLACE(cid, '-', '') AS cleaned_cid
FROM Bronze.erp_loc
WHERE cid LIKE '%-%';

PRINT 'Silver layer should have no hyphens:';
SELECT TOP 5 
    cid
FROM Silver.erp_loc
WHERE cid LIKE '%-%';

-- ===========================================================================
-- SUMMARY REPORT
-- ===========================================================================

PRINT CHAR(13) + '================================================================================';
PRINT 'DATA QUALITY TESTING SUMMARY';
PRINT '================================================================================';

-- Create summary table for test results
SELECT 
    'Bronze Layer' AS layer,
    'crm_cust_info' AS table_name,
    'Duplicate Customer IDs' AS test_description,
    (SELECT COUNT(DISTINCT cst_id) FROM Bronze.crm_cust_info WHERE cst_id IS NOT NULL) AS unique_count,
    (SELECT COUNT(*) FROM Bronze.crm_cust_info WHERE cst_id IS NOT NULL) AS total_count,
    CASE 
        WHEN (SELECT COUNT(*) FROM Bronze.crm_cust_info WHERE cst_id IS NOT NULL) = 
             (SELECT COUNT(DISTINCT cst_id) FROM Bronze.crm_cust_info WHERE cst_id IS NOT NULL)
        THEN 'PASS' 
        ELSE 'FAIL' 
    END AS test_result
UNION ALL
SELECT 
    'Silver Layer',
    'crm_cust_info',
    'Duplicate Customer IDs',
    (SELECT COUNT(DISTINCT cst_id) FROM Silver.crm_cust_info),
    (SELECT COUNT(*) FROM Silver.crm_cust_info),
    CASE 
        WHEN (SELECT COUNT(*) FROM Silver.crm_cust_info) = 
             (SELECT COUNT(DISTINCT cst_id) FROM Silver.crm_cust_info)
        THEN 'PASS' 
        ELSE 'FAIL' 
    END
-- Add more summary rows as needed...
ORDER BY layer, table_name;

PRINT '================================================================================';
PRINT 'TESTING COMPLETED';
PRINT 'Completion Time: ' + CONVERT(VARCHAR, GETDATE(), 120);
PRINT '================================================================================';
